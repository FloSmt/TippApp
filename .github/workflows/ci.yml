name: CI on Pull Request

on:
  pull_request:
    branches:
      - master
permissions:
  actions: read
  contents: read

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

jobs:
  # Job 1: Prepare (Setup Node.js, Install Dependencies, Restore Playwright Browsers)
  prepare:
    runs-on: ubuntu-latest
    outputs:
      ci_run_id: ${{ steps.start-nx-cloud-run.outputs.ci-run-id }}
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0

      - name: ğŸš€ Start Nx Cloud CI Run
        if: github.event_name == 'pull_request' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        id: start-nx-cloud-run
        run: npx nx-cloud start-ci-run --distribute-on="3 linux-medium-js" --stop-agents-after="e2e-ci"

      - name: ğŸ’¾ Cache Node Modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: ğŸ’¾ Cache Playwright Browsers
        id: cache-playwright-browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/playwright.config.ts') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: |
          node -v
          npm install

      - uses: nrwl/nx-set-shas@v4

      - name: â™»ï¸ Restore Playwright Browsers
        if: steps.cache-playwright-browsers.outputs.cache-hit != 'true'
        run: npx playwright install

      - name: ğŸ“„ Run Linting
        run: npx nx run-many -t lint --parallel --configuration=ci

  # Job 2: Run Unit Tests (Depends on Prepare)
  run-unit-tests:
    runs-on: ubuntu-latest
    needs: prepare
    env:
      NX_CLOUD_CI_RUN_ID: ${{ needs.prepare.outputs.ci_run_id }}
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: â™»ï¸ Restore Node Modules Cache
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ§ª Run Unit-Tests
        run: npx nx run-many --target=test --all --parallel --configuration=ci --coverage

      - name: ğŸ“¤ Upload Coverage Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: 'coverage/'

  # Job 3: Run Backend E2E Tests (Depends on Prepare)
  run-backend-e2e:
    runs-on: ubuntu-latest
    needs: prepare
    env:
      NX_CLOUD_CI_RUN_ID: ${{ needs.prepare.outputs.ci_run_id }}
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'npm'

      - name: â™»ï¸ Restore Node Modules Cache
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸš¢ Docker info (debug)
        run: |
          docker --version
          docker compose version || true
          docker info || true

      - name: ğŸš€ Start test containers with Docker Compose
        run: |
          npm run env:test

      - name: ğŸ§ª Run Backend E2E Tests
        env:
          NODE_ENV: test
          CI: true
          NX_CLOUD_CI_RUN_ID: ${{ needs.prepare.outputs.ci_run_id }}
        run: npx nx e2e backend-e2e -- --runInBand

      - name: ğŸ§¹ Cleanup Docker Compose (always)
        if: always()
        run: |
          docker compose -f docker-compose.test.yaml down --volumes --remove-orphans

  # Job 4: Run Frontend (Playwright) E2E Tests (Depends on Prepare)
  run-frontend-e2e:
    runs-on: ubuntu-latest
    needs: prepare
    env:
      NX_CLOUD_CI_RUN_ID: ${{ needs.prepare.outputs.ci_run_id }}
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: â™»ï¸ Restore Node Modules Cache
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}

      - name: â™»ï¸ Restore Playwright Browsers Cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/playwright.config.ts') }}


      - name: ğŸš€ Start Frontend for Playwright UI Tests
        run: |
          npx nx serve mobile-app --configuration=production --port=4200 &
          sleep 15
        env:
          NODE_ENV: test
          CI: true

      - name: ğŸ§ª Run Playwright UI Tests
        run: npx nx e2e mobile-app-e2e

      - name: ğŸ“¤ Upload Playwright Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
